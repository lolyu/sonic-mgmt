name: $(Build.DefinitionName)_Running_Init_$(Build.BuildId)_$(Date:yyyyMMdd)

trigger: none
pr: none

variables:
  - template: ./templates/template_variables.yml

parameters:
  - name: TESTBED_NAME
    type: string
    displayName: "Testbed Name"
    default: vms11-t0-s6000

  - name: IMAGE_URL
    type: string
    default: $(IMAGE_BRCM_202012)
    displayName: "Image URL"


  - name: PY_SAITHRIFT_URL
    type: string
    default: $(SAITHRIFTV2_BRCM_INTERNAL_202012)
    displayName: "py_saithrift URL"


  - name: SAI_REPO
    type: string
    displayName: "SAI Dev Repo"
    default: "opencomputeproject"

  - name: SAI_BRANCH
    type: string
    displayName: "SAI Dev Branch"
    default: "master"

  # Deploy vscode in PTF
  - name: PTF_DEPLOY_VSCODE
    displayName: "Deploy Vscode in PTF"
    type: boolean
    default: true

  # WorkFlow parameters
  - name: LOCK_TESTBED
    displayName: "Lock Testbed"
    type: boolean
    default: false

  - name: CHANGE_TOPO
    displayName: "Deploy non-topo"
    type: boolean
    default: true

  - name: PREPARE_SAI_TB
    displayName: "Prepare SAI Test Env"
    type: boolean
    default: true

  - name: UPDATE_IMAGE
    displayName: "Update Image"
    type: boolean
    default: true

  - name: RECOVER_TB
    displayName: "Recover Testbed"
    type: boolean
    default: false

  - name: ENABLE_PTF_SAI_TEST
    displayName: "Run PTF-SAI Test"
    type: boolean
    default: false

  - name: ENABLE_BRCM_T0_TEST
    displayName: "Run Brcm T0 Test"
    type: boolean
    default: false

  - name: ENABLE_COMMUNITY_TEST
    displayName: "Run community test case"
    type: boolean
    default: false

  - name: ENABLE_PTF_WARM_REBOOT_TEST
    displayName: "Run ptf warm reboot test"
    type: boolean
    default: false

  - name: ENABLE_T0_WARM_REBOOT_TEST
    displayName: "Run t0 warm reboot test"
    type: boolean
    default: false

  - name: UPLOAD_TEST_REPORT
    displayName: "Upload Test Report"
    type: boolean
    default: false

  - name: SAI_PTF_DOCKER
    type: string
    displayName: "SAI PTF DOCKER"
    default: docker-ptf-sai

  - name: JOB_CONFIG
    type: string
    displayName: "JOB CONFIG"
    default: " "

  # Checkout sai_qualify/ folder from public
  - name: OVERWRITE_INTERNAL_MGMT
    displayName: "overwrite internal sonic-mgmt sai_qualify/ folder"
    type: boolean
    default: true

  - name: MGMT_REPO
    displayName: "sonic-mgmt repo"
    type: string
    default: "sonic-net"

  - name: MGMT_BRANCH
    displayName: "sonic-mgmt branch"
    type: string
    default: "master"

  #Resource agent pool
  - name: AGENT_POOL
    displayName: "Resource agent pool"
    type: string
    default: nightly
    values:
      - nightly
      - nightly2
      - nightly-svc
      - nightly-bjw

  - name: RUNTIME_SCAN
    displayName: "runtime scan"
    type: boolean
    default: false

stages:
- stage: RunSAITest
  jobs:
  - template: templates/sai_test.yml
    parameters:
      TESTBED_NAME: ${{ parameters.TESTBED_NAME }}
      LOCK_TESTBED: ${{ parameters.LOCK_TESTBED }}
      PREPARE_SAI_TB: ${{ parameters.PREPARE_SAI_TB }}
      UPDATE_IMAGE: ${{ parameters.UPDATE_IMAGE }}
      CHANGE_TOPO: ${{ parameters.CHANGE_TOPO }}
      RECOVER_TB: ${{ parameters.RECOVER_TB }}
      ENABLE_PTF_SAI_TEST: ${{ parameters.ENABLE_PTF_SAI_TEST }}
      ENABLE_BRCM_T0_TEST: ${{ parameters.ENABLE_BRCM_T0_TEST }}
      ENABLE_COMMUNITY_TEST: ${{ parameters.ENABLE_COMMUNITY_TEST }}
      ENABLE_PTF_WARM_REBOOT_TEST: ${{ parameters.ENABLE_PTF_WARM_REBOOT_TEST }}
      ENABLE_T0_WARM_REBOOT_TEST: ${{ parameters.ENABLE_T0_WARM_REBOOT_TEST }}
      RUN_TEST: ${{ or( parameters.ENABLE_PTF_SAI_TEST, parameters.ENABLE_BRCM_T0_TEST, parameters.ENABLE_COMMUNITY_TEST, parameters.ENABLE_PTF_WARM_REBOOT_TEST, parameters.ENABLE_T0_WARM_REBOOT_TEST ) }}
      PY_SAITHRIFT_URL: ${{ parameters.PY_SAITHRIFT_URL }}
      IMAGE_URL: ${{ parameters.IMAGE_URL }}
      SAI_PTF_DOCKER: ${{ parameters.SAI_PTF_DOCKER }}
      SAI_REPO: ${{ parameters.SAI_REPO }}
      SAI_BRANCH: ${{ parameters.SAI_BRANCH }}
      JOB_CONFIG: ${{ parameters.JOB_CONFIG }}
      UPLOAD_TEST_REPORT: ${{ parameters.UPLOAD_TEST_REPORT }}
      PTF_DEPLOY_VSCODE: ${{ parameters.PTF_DEPLOY_VSCODE }}
      OVERWRITE_INTERNAL_MGMT: ${{ parameters.OVERWRITE_INTERNAL_MGMT }}
      MGMT_REPO: ${{ parameters.MGMT_REPO }}
      MGMT_BRANCH: ${{ parameters.MGMT_BRANCH }}
      AGENT_POOL: ${{ parameters.AGENT_POOL }}
      RUNTIME_SCAN: ${{ parameters.RUNTIME_SCAN }}
